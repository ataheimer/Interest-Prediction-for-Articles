t bayesian likelihood method fit multilevel model complex level variat a multilevel model common practic assum constant varianc level across individu paper consid situat level varianc depend predictor variabl examin two case use dataset educ research first case varianc level test score depend continu intak score predictor second case varianc assum differ accord gender contrast two maximumlikelihood method base iter generalis least squar two markov chain mont carlo mcmc method base adapt hybrid version metropolishast mh algorithm use two simul experi compar four method find four approach good repeatedsampl behaviour class model simul conclud contrast raw logscal formul level varianc function find adapt mh sampl consider effici adapt reject sampl heteroscedast model polynomi log scale b introduct past year so tting multilevel model data hierarch nest structur becom increasingli common statistician mani applic area eg goldstein bryk raudenbush draper main purpos tting model partit variat respons variabl function level hierarchi relat variabl descript data structur educ exampl multilevel model use calcul proport variat observ explain variabl student class school level nest structur randomeect model kind gener combin xedeect model predictor addit relat respons variabl covari gener model assum constant level varianc error residu term observ in notat student level level structur abov reason true applic altern allow heteroscedasticityin word model relat amount level variabl predictor variabl refer complex level variat heteroscedast common model concern standard tting institut educ univers london bedford way london wch al uk email bwjsmsrioeacuk wjb hgoldsteinioeacuk hg teuejraioeacuk jr depart mathemat scienc univers bath claverton down bath ba ay uk email ddrapermathsbathacuk web httpwwwbathacukmasdd w j brown d draper h goldstein j rasbash tabl comparison mean varianc normalis exam score variou partit gcse dataset partit size mean varianc whole dataset boy girl standardis lrt standardis lrt standardis lrt standardis lrt standardis lrt standardis lrt linear model data lack hierarch multilevel structur eg weisberg far less attent paid topic multilevel data main motiv exampl consid dataset studi rasbash et al origin analys goldstein et al dataset contain exam result pupil school sampl six inner london educ author iti respons variabl interest total score achiev gcse examin a standardis test taken age pupil variabl alreadi normalis transform replac valu standard normal score dataset consid tabl contain mean varianc estim respons variabl variou partit dataset one main predictor interest score read test lrt pupil took age purpos partit divid pupil group roughli equal sampl size base standardis version lrt score mean column tabl clear girl gener bit better boy lrt score posit correl exam score also seen boy exam score slightli variabl girl score varianc exam score bear roughli quadrat relationship lrt score conclus mean tting multilevel model dataset worth consid need complex variat level plan paper follow section describ two variat maximumlikelihood approach tting multilevel model complex level variat examin sever exampl complex varianc structur section present markov chain mont carlo mcmc method bayesian tting model base adapt metropolishast sampl use two dierent propos distribu tion section give result two simul studi investig bia interv coverag properti repeat sampl four tting method describ previou three section section examin altern a mcmc method b formul complex varianc structur section discuss conclus suggest extens work present here fit multilevel model complex level variat maximumlikelihoodbas method complex varianc structur begin describ gener level model complex variat later section examin method altern gener model addit constraint ad basic structur gener gaussian multilevel model n n x v n vector respons necessarili independ distribut p f vector xedeect coecient predictor n n total number level observ data set student exampl section p f number xed eect model n n covari matrix v respons contain random structur model twolevel case write varianc term v level unit j express varianc partit separ term two level e u denot random eect level respect covari respons form v iji two observ level unit v iji mean vector order observ level unit group togeth v block diagon form gener formul level level varianc covari potenti dierent pair observ import special case exist simpler structur eg variancecompon model level level varianc constant across observ covari x may make appear random structur model lead partit uij exampl randomslop regress model singl predictor x ij uij u u consist varianc covari term level express matrix with structur zero nece sari use notat gener withinblock covari term written vector predictor languag section refer earlier complex variat level simpli mean partit level varianc depend natur way predictor variabl figur present sever potenti varianc structur tted gcse dataset describ earlier correspond model eij uij eij uij eij w j brown d draper h goldstein j rasbash standardis lrt score levelvari model standardis lrt score varianc level varianc level varianc standardis lrt score varianc level varianc level varianc standardis lrt score varianc model level varianc boy level varianc girl level varianc figur four dierent varianc structur tted gcse dataset uij eij model x refer standardis lrt score x refer gender code boy girl equat simpl onelevel regress model quadrat varianc relationship lrt model involv tting increasingli complex varianc structur data twolevel framework one approach tting model via maximum likelihood ml base iter generalis least squar igl restrict variant rigl also known reml correct bia basic idea similar em algorithm a estim obtain use current estim v b estim v obtain use a iglsrigl estim fit multilevel model complex level variat tabl igl estim model tted gcse dataset standard error se parenthes model paramet u u u e e covari matrix v recast regress problem weight least squar use step see goldstein detail tabl estim obtain model appli gcse data gender lrt score evid use predict gcse score model naiv ignor hierarch natur data hint heteroscedast the ml estim e big standard error se from estim u equat clear need twolevel model full complex requir describ data come focu model in everi estim least time larg se mcmc method gener level gaussian model complex level variat brown draper a b gave gibbssampl algorithm bayesian tting level variancecompon randomslopesregress model respect section consid gener level model complex variat level easili generalis nlevel model via approach similar method detail brown mcmc tting model use rewrit follow ij denot scalar outcom level observ level unit e p f p p vector xedeect paramet level level residu vector predictor valu p p number paramet specifi random eect level respect iglsrigl method directli estim estim tting model use method given w j brown d draper h goldstein j rasbash goldstein equat e u varianc term level level gibb sampl procedur tting multilevel model proceed smoothli treat level residu latent variabl form full condit posterior distribut multilevel model simpl homoscedast variat level level residu may calcul iter subtract model cannot explicitli comput individu level residu instead deal composit residu x c calcul subtract import part algorithm follow store composit level varianc function individu paramet depend level covari matrix e individu varianc mean algorithm follow apart updat step e almost ident algorithm model without complex variat brown inversewishart propos level covari matrix rst mcmc method examin paper collect togeth term varianc equat level eij covari matrix e updat e use metropolishast mh algorithm therefor requir propos distribut gener positivedenit matric later relax restrict use inversewishart propos distribut expect current estim e iter gener e parameteris use exampl gelman carlin et al inversewishart distribut w expect e w posit integ degre freedom paramet produc distribut expect e paramet w tune constant may set integ valu give desir mh accept rate prior distribut paramet model make follow choic algorithm gener prior e to speci section level covari matrix inversewishart prior level covari matrix multivari normal prior n p f xed eect paramet vector algorithm detail appendix hybrid gibb mh step divid paramet latent variabl four block use multivari normal gibb updat u j inversewishart gibb updat u inversewishart mh propos e adapt method choos tune constant w brown draper b describ adapt hybrid metropolisgibb sampler tting randomeect logist regress model gibb sampl may use model varianc paramet metropoli updat need xed eect latent residu brown draper employ seri univari normal propos distribut pd quantiti give procedur adapt choic appropri fit multilevel model complex level variat tabl illustr adapt mh procedur model appli gcse data accept within iter rate w toler valu varianc pd achiev ecient mh accept rate provid modic procedur case inversewishart propos set tune paramet w describ arbitrari start valu in exampl follow run algorithm batch iter goal achiev accept rate level covari matrix lie within speci toler interv r compar empir accept rate r current batch iter toler interv modifi propos distribut appropri proceed next batch modic perform end batch follow r r integ part w use amount w alter iter procedur increas function distanc r r adapt procedur end three success r valu lie within toler interv valu w xed proceed usual burnin monitor period exampl consid model section quadrat relationship varianc lrt predictor model adapt procedur run model target accept rate base recommend gelman robert gilk toler summaris progress adapt method exampl iter requir adjust propos distribut give desir accept rate iter typic need applic examin tabl compar estim produc mcmc method model a igl rigl procedur b anoth mcmc method describ next section here throughout paper mcmc point estim posterior mean use slightli inform inversewishart prior level covari matrix mcmc method base rigl estim uniform prior level covari matrix case result method fairli similar one except paramet e notic larger use mcmc w j brown d draper h goldstein j rasbash tabl paramet estim four method tting model london school dataset sesposterior standard deviat parenthes mcmc method monitor iter adapt procedur burnin iter mcmc method paramet igl rigl method dierenc highlight fact rst mcmc approach actual ts model extra positivedenit constraint forc e posit ate point estim second mcmc method consid below base dierent constraint examin chain valu produc e found nearli valu neg inconsist result model examin next section e varianc truncat normal propos level varianc func tion inversewishart updat method assum varianc function level aris positivedenit covari matrix consid altern method that manner similar igl rigl requir varianc level linear function paramet mcmc solut still constraint igl solut still consid level level varianc separ quantiti must posit constraint use mcmc method covari matrix level positivedenit actual stronger necessari positivedenit matric guarante vector x c ij produc posit varianc equat milder still scientic reason constraint allow valu e j restrict appear complic work with consid paramet e separ assum variabl xed constraint becom manag use rewrit model time follow e e eij given equat composit level residu e normal distribut varianc depend predictor consequ fit multilevel model complex level variat constraint level varianc alway posit still satis e need positivedenit mh updat method second method ident rst u j appendix involv hast updat dierent propos distribut e updat paramet level varianc equat turn alway requir j everi iter markov chain consid rst diagon term ekk c x c kth element vector x c ij equival requir c use normal propos distribut varianc kk reject gener valu fail satisfi amount use truncat normal propos shown figur i hast ratio r calcul ratio two truncat normal distribut shown figur i ii let valu ekk time propos valu time kk kk updat step follow ekk probabl min ekk otherwis correspond densiti denomin given diagon term special case alway multipli posit quantiti varianc equat propos distribut need one truncat point gener nondiagon term ekl get follow befor time j constraint must satis k l p rewritten ekl c c ekl w j brown d draper h goldstein j rasbash iv figur plot truncat univari normal propos distribut paramet current valu c b propos new valu max min truncat point distribut i iii mean c distribut ii iv mean equival two constraint i j x c ekl min ekl min ij i j x c use normal propos distribut time varianc kl valu fail satisfi reject lead truncat normal propos shown figur iii hast ratio r simpli ratio two truncat normal distribut shown figur iii iv let valu ekl time fit multilevel model complex level variat propos valu time kl kl min ekl kl kl updat step similar subscript kl place kk e term propos distribut varianc prior distribut method outlin consid paramet e separ mean use separ truncat univari normal propos distribut paramet subject constraint valu gener produc posit level varianc eij j therefor need choos propos distribut varianc paramet two possibl solut use varianc paramet estim rigl procedur multipli suitabl posit scale factor use adapt approach burnin monitor run simul see brown draper a descript method case random eect logist regress model prior distribut use method must take account constraint impos paramet analys perform paper method use seri margin uniform prior level varianc term subject constraint word valid combin paramet estim e priori equal like prior distribut may problemat exampl model tted gcse data section estim produc mcmc method shown tabl truncat normal method use adapt mh procedur case desir accept rate paramet updat separ advantag truncat normal method handl varianc function would necessarili positivedenit matrix form illustr consid simpl case inversewishart method cannot t model follow model includ varianc boy term repres dierenc varianc boy girl result tting model given tabl method give roughli estim level varianc term total varianc produc model similar valu given part tabl varianc respons calcul boy girl separ w j brown d draper h goldstein j rasbash tabl paramet estim three method tted model gcse dataset method use truncat normal propos monitor iter follow adapt period burnin iter mcmc paramet igl rigl method simul studi section examin bia intervalcoverag properti repeat sampl four method describ abov two set simul model complex level variat base gcse exampl rst consid model featur quadrat varianc relationship input read test lrt predictor true popul paramet simul use valu close estim obtain actual data one except increas e correl random eect level reduc sampl dataset drawn multilevel model high correl caus converg problem igl rigl method brown draper b one thousand dataset gener randomli accord model with number level level unit respect origin gcse data set distribut level observ within level unitsand tted use four method result present tabl mcmc method in simul studi posterior distribut dataset monitor iter adapt period burnin igl start valu uniform prior use level varianc xed eect slightli inform inversewishart prior use level covari matrix line result brown draper b interv estim nomin level igl rigl approach form base largesampl normal approxim user multilevel packag mlwin rasbash et al hlm bryk et al would report report interv estim sinc packag routin report estim standard error maximumlikelihood method bayesian mcmc method give result base posterior mean point estim central posterior interv second simul studi tabl base model section male femal subsampl dierent level varianc mcmc method avail model creat simul dataset popul valu similar estim obtain gcse dataset bayesian approach tting uniform prior use level varianc xed eect fit multilevel model complex level variat tabl summari result rst simul studi lrt score random level bia result a rel except bracket absolut the true valu case zero mont carlo standard error se a given parenthes mont carlo se estim interv coverag b rang a rel bia point estim paramet mcmc mcmc ftrue valueg igl rigl method method u fg b interv coverag probabl nomin level mcmc mcmc paramet igl rigl method method u u e e c mean interv width nomin level mcmc mcmc paramet igl rigl method method w j brown d draper h goldstein j rasbash tabl summari result second simul studi separ varianc level boy girl mont carlo standard error se a given parenthes mont carlo se estim interv coverag b rang a rel bia point estim paramet mcmc ftrue valueg igl rigl method b interv coverag probabl nomin level mcmc paramet igl rigl method u c mean interv width nomin level mcmc paramet igl rigl method fit multilevel model complex level variat prior with use level varianc paramet line result brown draper a evid tabl four method perform reason well model rigl succeed reduc alreadi small bias aris igl estim case rel bias mcmc method also small rang median absolut valu interv coverag four method close nomin actual coverag rang nomin respect four method achiev level coverag interv compar length ratio interv length method close valu expect normal ml method clear advantag speed on origin gcse data set iglsrigl mcmc method took second mhz pentium pc respect mcmc method base monitor iter ml approach two potenti disadvantag data set small number level level unit requir sophist method construct interv estim varianc paramet to achiev good coverag properti largesampl normal approxim use brown draper ab may fail converg e andor matric exhibit high degre correl paramet quantifi random eect bayesian method consider slower addit advantag infer arbitrari function model paramet automat model paramet monitor mcmc method gibb sampl special case problem complex level variat tted use standard gibb sampler model equat use second simul use dierent level varianc term gender one exampl could reparameteris model two varianc one boy b one girl rather boy varianc plu dierenc scaledinvers prior see eg gelman et al use two varianc paramet respect divid children boy girl subgroup b g size n b n g step algorithm given appendix rewritten two gibb sampl step follow full condit b full condit g exactli analog level varianc step algorithm befor model varianc log scale develop softwar packag bug spiegelhalt et al use dierent approach tting complex level variat one exampl school data w j brown d draper h goldstein j rasbash set exampl volum spiegelhalt et al model logarithm level precis function predictor paramet result multipl rather addit varianc function exp advantag approach paramet unconstrain level varianc never neg easier specifi prior method disadvantag interpret individu coecient easi comput model slower interpret diculti appar mainli x variabl categor model tted bug use adapt reject ar sampl gilk wild altern adapt mh method use truncat normal algorithm section use time paramet constraint henc truncat normal propos distribut goldstein appendix show obtain ml estim model see yang et al set mlwin macro thi explor dierenc logvari model earlier approach tted four dierent level varianc function gcse dataset model eect lrt score x level varianc consid quadrat relationship examin earlier model simpler linear relationship eij also consid two exponenti relationship four model level varianc structur xed eect equat figur plot result level estim varianc function lrt score case major data varianc estim produc four model fairli similar discrep model occur extrem lrt rang rel observ tabl present estim four model use mh method togeth rafterylewi default diagnost for mh ar sampl exponenti model compar time part b tabl evid paramet worst mcmc mix intercept mean that although mh method requir longer monitor run ar approach fit multilevel model complex level variat standardis lrt score levelvari quadrat exp linear exp quadrat figur four way model eect standardis lrt score level varianc gcse dataset level varianc paramet run length requir ensur paramet estim speci accuraci with respect interv estim roughli equal part c tabl seen mh approach time faster realtim execut speed exampl result tabl base singl data set typic nding obtain similar model conclus extens paper present sever method model nonconst level varianc function multilevel data introduc two new adapt metropolishast sampl method tting function subject dierent constraint two method give similar estim model true paramet valu aect constraint true valu satisfi addit posit denit matrix constraint inversewishart propos method estim two method dier main advantag inversewishart method model level varianc function matrix manner analog usual treatment level varianc function mean among thing inform inversewishart prior level use approach main advantag truncat normal propos method gener deal varianc function level w j brown d draper h goldstein j rasbash tabl paramet estim four dierent level varianc function appli gcse dataset mcmc method use monitor period iter burnin iter method adapt mh step level run use develop version mlwin adapt reject ar step level run winbug posterior standard deviat given parenthes a a paramet estim exponenti exponenti paramet linear quadrat linear quadrat e b rafterylewi valu in thousand iter main entri appli mh method correspond valu ar parenthes exponenti exponenti n linear quadrat linear quadrat u e c time in minut pentium mhz exponenti exponenti method linear quadrat linear quadrat metropolishast adapt reject fit multilevel model complex level variat method bia interv coverag properti similar maximumlikelihood igl rigl approach four method perform satisfactorili repeat sampl regard section consid altern formul level varianc function term log precis level method two advantag need impos constraint term result varianc function therefor easier contempl varieti prior distribut result varianc paramet main disadvantag approach individu term varianc function may easili interpret make potenti dicult construct sensibl inform prior tabl show clearli howev adapt reject sampl much less ecient adapt metropolishast sampl achiev default mcmc accuraci standard varianc or precis function exponenti paramet two obviou extens work arbitrari varianc structur higher level multivari normal respons two approach tting random eect level appear common current appli work model random eect independ tting fulli depend random eect complet covari matrix level see birat exampl spiegelhalt et al illustr formul fairli easi blockdiagon covari structur higher level use gibb sampl straightforward extens approach given section adapt mh sampler truncat normal propos method section use depend structur among random eect higher level includ non blockdiagon covari matric multivari normal respons model varianc function lowest level includ varianc respons plu covari respons varianc function could also extend includ predictor may uenc varianc individu respons analog way univari model intend report mcmc sampl algorithm gener multivariaterespons multilevel model elsewher acknowledg grate epsrc esrc european commiss nancial support david spiegelhalt nicki best particip bug project refer comment set multilevel model paper base rst author phd dissert membership list impli agreement idea express here peopl respons error may present appendix detail mcmc method step algorithm describ section full condit distribut gibb updat xed eect paramet vector multivari normal p f w j brown d draper h goldstein j rasbash number xed eect eij eij involv gibb updat level residu u j also multivari normal full condit distribut p number paramet describ random eect level n j number level unit level unit j pn eij pn eij step employ hast updat use inversewishart propos distribut level covari matrix e specic markov chain move e time e follow e probabl min e e e otherwis a e w e w chosen section p number row column b hast ratio r exp tr e e tr e c full condit distribut e eij exp express righthand side conveni term eij equat final step involv gibb updat level covari matrix express ofu full condit e number row column u j number level unit data set improp uniform prior u correspond choic fit multilevel model complex level variat r appli mcmc method multilevel model bryk bryk bayesian hierarch model bayesian data analysi adapt reject sampl gibb sampl multilevel mix linear model analysi use iter generalis least squar restrict unbias iter generalis least squar estim multilevel statist model second edit multilevel analysi school examin result mani iter gibb sampler user guid mlwin version bug exampl version ii cambridg medic research council biostatist unit bug bayesian infer use gibb sampl version appli linear regress mlwin macro advanc multilevel model version tr